pipeline {
    agent none

    environment {
        REGISTRY        = 'registry.vincent-guillet.fr'

        BACKEND_IMAGE   = "${REGISTRY}/fullstack-template-backend:main-latest"
        FRONTEND_IMAGE  = "${REGISTRY}/fullstack-template-frontend:main-latest"

        COMPOSE_PROJECT = 'fullstack-template'
    }

    stages {

        stage('Build & Push Docker Images') {
            agent { label 'ct-home-dev' }

            steps {
                checkout scm

                dir('backend') {
                    sh """
                        set -e
                        echo "=== Build BACKEND ==="
                        docker build -t ${BACKEND_IMAGE} .
                    """
                }

                dir('frontend') {
                    sh """
                        set -e
                        echo "=== Build FRONTEND ==="
                        docker build -t ${FRONTEND_IMAGE} .
                    """
                }

                sh """
                    set -e
                    echo "=== Push images ==="
                    docker push ${BACKEND_IMAGE}
                    docker push ${FRONTEND_IMAGE}
                """
            }
        }

        stage('Deploy') {
            agent { label 'ct-home-dev' }

            steps {
                checkout scm

                withEnv([
                    "DOCKER_HOST=unix:///var/run/docker.sock",
                    "COMPOSE_PROJECT_NAME=${COMPOSE_PROJECT}",

                    // Variables inject√©es directement (exemples)
                    "BACKEND_IMAGE=${BACKEND_IMAGE}",
                    "FRONTEND_IMAGE=${FRONTEND_IMAGE}"
                ]) {
                    sh """
                        set -e

                        echo "=== docker compose down ==="
                        docker compose -f docker-compose.yml down || true

                        echo "=== docker compose pull ==="
                        docker compose -f docker-compose.yml pull

                        echo "=== docker compose up ==="
                        docker compose -f docker-compose.yml up -d --force-recreate
                    """
                }
            }
        }
    }
}
