pipeline {
    agent none

    environment {
        REGISTRY           = 'registry.vincent-guillet.fr'

        // Images "main-latest" (une seule branche)
        BACKEND_IMAGE      = "${REGISTRY}/fullstack-template-api:main-latest"
        FRONTEND_IMAGE     = "${REGISTRY}/fullstack-template-client:main-latest"

        COMPOSE_PROJECT    = 'fullstack-template'
    }

    stages {

        stage('Build & Push Docker Images') {
            agent { label 'ct-home-dev' }

            steps {
                checkout scm

                // ----- Build BACKEND -----
                dir('api') {
                    sh """
                        set -e
                        echo "=== Build image BACKEND ${BACKEND_IMAGE} ==="
                        docker build -t ${BACKEND_IMAGE} .
                    """
                }

                // ----- Build FRONTEND -----
                dir('client') {
                    sh """
                        set -e
                        echo "=== Build image FRONTEND ${FRONTEND_IMAGE} ==="
                        docker build -t ${FRONTEND_IMAGE} .
                    """
                }

                // ----- Push vers registry -----
                sh """
                    set -e
                    echo "=== Push images vers ${REGISTRY} ==="
                    docker push ${BACKEND_IMAGE}
                    docker push ${FRONTEND_IMAGE}
                """
            }
        }

        stage('Deploy PROD (main)') {
            agent { label 'ct-home-projets' }

            steps {
                checkout scm

                withEnv([
                    "DOCKER_HOST=unix:///var/run/docker.sock",
                    "COMPOSE_PROJECT_NAME=${env.COMPOSE_PROJECT}"
                ]) {
                    sh """
                        set -e

                        echo "=== [PROD] docker compose down ==="
                        docker compose -f docker-compose.prod.yml down || true

                        echo "=== [PROD] docker compose pull ==="
                        docker compose -f docker-compose.prod.yml pull

                        echo "=== [PROD] docker compose up (force recreate) ==="
                        docker compose -f docker-compose.prod.yml up -d --force-recreate
                    """
                }
            }
        }
    }
}
